# Функция добавления кандидатов к вакансии

## Обзор

Реализована возможность добавления кандидатов к вакансиям прямо из списка кандидатов. Это ключевая функция CRM, которая позволяет рекрутеру быстро связывать кандидатов с активными вакансиями.

## Как это работает

### 1. Добавление одного кандидата

**Способ 1: Кнопка "Отправить" в карточке**
```
1. В карточке кандидата нажать кнопку 📤 (Отправить)
2. Откроется модальное окно со списком активных вакансий
3. Выбрать нужную вакансию
4. Кандидат автоматически:
   - Привязывается к вакансии (vacancyId)
   - Привязывается к компании (companyId)
   - Меняет статус на "Отправлен заказчику"
   - В историю добавляется запись о действии
```

### 2. Массовое добавление кандидатов

**Способ 2: Выбор нескольких кандидатов**
```
1. Отметить чекбоксы у нужных кандидатов (2, 5, 10...)
2. Внизу появится панель с кнопкой "Добавить к вакансии"
3. Нажать кнопку
4. Откроется то же модальное окно выбора вакансии
5. Выбрать вакансию
6. Все выбранные кандидаты добавляются к вакансии одновременно
```

## Модальное окно выбора вакансии

### Структура окна

```
┌─────────────────────────────────────────┐
│ Добавить кандидата в вакансию        ✕ │
│ Выбрано кандидатов: 3                   │
├─────────────────────────────────────────┤
│                                         │
│ Выберите вакансию                       │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 💼 Senior Frontend Developer        │ │
│ │    Caseware Ukraine               → │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 💼 Middle Node.js Developer         │ │
│ │    Caseware Ukraine               → │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│           [ Отменить ]                  │
└─────────────────────────────────────────┘
```

### Пустое состояние (нет вакансий)

Если у рекрутера еще нет созданных вакансий, показывается:

```
┌─────────────────────────────────────────┐
│ Добавить кандидата в вакансию        ✕ │
│ Выбран 1 кандидат                       │
├─────────────────────────────────────────┤
│                                         │
│           💼                            │
│                                         │
│   У вас пока нет созданных вакансий     │
│                                         │
│   Создайте первую вакансию, чтобы       │
│   начать процесс подбора кандидатов     │
│                                         │
│      [+ Создать вакансию]               │
│                                         │
└─────────────────────────────────────────┘
```

При нажатии "Создать вакансию" пользователь переходит на страницу создания вакансии.

## Технические детали

### Компоненты

**CandidateList.tsx:**
- Добавлен state `addToVacancyModalVisible`
- Добавлен state `selectedCandidateForVacancy`
- Функция `handleOpenAddToVacancy(candidateId)` - открыть модал для одного
- Функция `handleBulkAddToVacancy()` - открыть модал для нескольких
- Функция `handleAddToVacancy(vacancyId)` - выполнить добавление
- Функция `renderAddToVacancyModal()` - рендер модального окна

**Props:**
```typescript
interface CandidateListProps {
  candidates: Candidate[];
  vacancies?: Array<{
    id: string;
    title: string;
    companyId: string;
    companyName?: string;
  }>;
  onToggleShortlist: (id: string) => void;
  onStatusChange: (candidateId: string, newStatus: CandidateStatus, comment: string) => void;
  onAddToVacancy?: (candidateIds: string[], vacancyId: string) => void;
}
```

### AppContext

Добавлена функция `handleAddToVacancy`:

```typescript
const handleAddToVacancy = (candidateIds: string[], vacancyId: string) => {
  const vacancy = vacancies.find(v => v.id === vacancyId);
  if (!vacancy) return;

  setCandidates(prev => prev.map(c => {
    if (candidateIds.includes(c.id)) {
      const interaction: Interaction = {
        id: `int_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`,
        date: new Date().toISOString(),
        type: 'status_change',
        user: currentUser.name,
        details: `Кандидат добавлен к вакансии "${vacancy.title}"`,
        statusBefore: c.status,
        statusAfter: CandidateStatus.SENT_TO_CLIENT
      };

      return {
        ...c,
        vacancyId: vacancyId,
        companyId: vacancy.companyId,
        status: CandidateStatus.SENT_TO_CLIENT,
        history: [interaction, ...c.history],
      };
    }
    return c;
  }));
};
```

**Что происходит:**
1. Находит вакансию по ID
2. Для каждого выбранного кандидата:
   - Устанавливает `vacancyId`
   - Устанавливает `companyId` (из вакансии)
   - Меняет статус на `SENT_TO_CLIENT`
   - Добавляет запись в историю
3. Очищает выделение
4. Закрывает модальное окно

### Использование в странице

**app/(tabs)/candidates.tsx:**

```typescript
export default function CandidatesScreen() {
  const {
    visibleCandidates,
    toggleShortlist,
    handleStatusChange,
    handleAddToVacancy,
    vacancies,
    companies
  } = useApp();

  // Подготовка списка вакансий с названиями компаний
  const vacanciesWithCompany = useMemo(() => {
    return vacancies
      .filter(v => v.status === 'active')
      .map(v => ({
        id: v.id,
        title: v.title,
        companyId: v.companyId,
        companyName: companies.find(c => c.id === v.companyId)?.name
      }));
  }, [vacancies, companies]);

  return (
    <CandidateList
      candidates={visibleCandidates}
      vacancies={vacanciesWithCompany}
      onToggleShortlist={toggleShortlist}
      onStatusChange={handleStatusChange}
      onAddToVacancy={handleAddToVacancy}
    />
  );
}
```

## UI/UX особенности

### Дизайн модального окна

**Цвета и стили:**
- Overlay: rgba(0, 0, 0, 0.5) - полупрозрачный черный
- Modal background: #FFFFFF
- Border radius: 20px (top corners)
- Max height: 70% экрана
- Min height: 300px

**Карточки вакансий:**
- Padding: 16px
- Background: #FAFAFA
- Border: 1px solid #E4E4E7
- Border radius: 10px
- Gap between cards: 12px

**Empty state:**
- Icon size: 48px
- Icon color: #D4D4D8 (светло-серый)
- Title: 18px, weight 600
- Text: 14px, weight 400, color #71717A

### Анимации

- Модальное окно появляется с fade эффектом
- Overlay затемняет фон
- При клике вне модального окна - закрывается

### Доступность

- Кнопка закрытия (X) в правом верхнем углу
- Кнопка "Отменить" внизу
- Клик по overlay закрывает окно
- onRequestClose обрабатывает Back button на Android

## Интеграция с другими функциями

### 1. История взаимодействий

При добавлении к вакансии создается запись:
```typescript
{
  id: 'int_...',
  date: '2026-01-13T12:00:00Z',
  type: 'status_change',
  user: 'Алексей Петров',
  details: 'Кандидат добавлен к вакансии "Senior Frontend Developer"',
  statusBefore: 'Ожидает отправки',
  statusAfter: 'Отправлен заказчику'
}
```

### 2. Фильтрация

После добавления к вакансии:
- Кандидат доступен для фильтрации по этой вакансии
- Клиент компании видит этого кандидата
- Статус обновляется в Kanban доске

### 3. Множественные вакансии

**Текущая реализация:** один кандидат = одна вакансия

**Будущее улучшение:** возможность добавлять одного кандидата к нескольким вакансиям:
```typescript
// Вместо vacancyId: string
vacancyIds: string[]

// В историю добавлять для каждой вакансии
```

## Примеры использования

### Сценарий 1: Быстрая отправка

```
Рекрутер нашел идеального кандидата:
1. Открыл список кандидатов
2. Нашел "Иван Сергеев" (92% match)
3. Нажал кнопку 📤 в карточке
4. Выбрал "Senior Frontend Developer"
5. Готово! Кандидат отправлен клиенту

Результат:
- Иван теперь привязан к вакансии
- Клиент видит Ивана в своей панели
- Статус изменен на "Отправлен заказчику"
- В истории записано действие
```

### Сценарий 2: Массовая отправка

```
Рекрутер подобрал шортлист из 5 кандидатов:
1. Отфильтровал по навыкам "React, TypeScript"
2. Выбрал 5 кандидатов с AI Score > 85%
3. Нажал "Добавить к вакансии"
4. Выбрал вакансию "Senior Frontend Developer"
5. Все 5 кандидатов отправлены одним кликом

Результат:
- Все 5 кандидатов привязаны к вакансии
- Клиент получил сразу 5 профилей на рассмотрение
- Экономия времени рекрутера
```

### Сценарий 3: Первая вакансия

```
Новый рекрутер только начал работу:
1. Добавил 10 кандидатов в базу
2. Попытался отправить первого клиенту
3. Увидел сообщение "У вас пока нет созданных вакансий"
4. Нажал "Создать вакансию"
5. Создал первую вакансию
6. Вернулся и успешно отправил кандидата

Результат:
- Плавный onboarding flow
- Понятная подсказка, что делать дальше
- Минимум кликов для решения проблемы
```

## Валидация и обработка ошибок

### Проверки

1. **Список вакансий пуст:**
   - Показываем empty state
   - Предлагаем создать вакансию

2. **Вакансия не найдена:**
   ```typescript
   if (!vacancy) return;
   ```
   - Молча игнорируем (не должно произойти)

3. **Нет выбранных кандидатов:**
   ```typescript
   if (candidateIds.length > 0) {
     // выполняем добавление
   }
   ```

4. **Callback не передан:**
   ```typescript
   if (onAddToVacancy && candidateIds.length > 0) {
     onAddToVacancy(candidateIds, vacancyId);
   }
   ```

## Будущие улучшения

### 1. Уведомления

После добавления показывать toast:
```
✅ Кандидат "Иван Сергеев" добавлен к вакансии "Senior Frontend Developer"
```

Или для множественного:
```
✅ 5 кандидатов добавлены к вакансии "Senior Frontend Developer"
```

### 2. Undo/отмена

Возможность отменить действие:
```
✅ 3 кандидата добавлены к вакансии    [Отменить]
```

### 3. Группировка вакансий

В модальном окне группировать по компаниям:
```
Caseware Ukraine
  - Senior Frontend Developer
  - Middle Node.js Developer

Global Logistics Corp
  - DevOps Engineer
```

### 4. Поиск вакансий

При большом количестве вакансий добавить поиск:
```
┌─────────────────────────────────────┐
│ 🔍 Поиск вакансии...                │
└─────────────────────────────────────┘
```

### 5. Недавние вакансии

Показывать часто используемые вакансии наверху:
```
Недавние
  - Senior Frontend Developer (5 кандидатов)
  - Middle Backend Developer (3 кандидата)

Все вакансии
  - ...
```

### 6. Bulk actions с разными вакансиями

Возможность отправить разных кандидатов на разные вакансии:
```
Кандидат 1 → Вакансия A
Кандидат 2 → Вакансия B
Кандидат 3 → Вакансия A
```

## Тестирование

### Чек-лист для тестирования

- [ ] Открывается модал при клике на 📤
- [ ] Показывается список активных вакансий
- [ ] Отображается название компании
- [ ] Клик по вакансии добавляет кандидата
- [ ] Модал закрывается после выбора
- [ ] Выделение снимается после добавления
- [ ] Статус меняется на "Отправлен заказчику"
- [ ] В историю добавляется запись
- [ ] Empty state показывается при отсутствии вакансий
- [ ] Кнопка "Создать вакансию" работает
- [ ] Массовое добавление работает корректно
- [ ] Кнопка "Отменить" закрывает модал
- [ ] Клик по overlay закрывает модал
- [ ] Кнопка X закрывает модал

### Edge cases

- [ ] 0 вакансий - empty state
- [ ] 1 вакансия - показывается корректно
- [ ] 100 вакансий - скроллинг работает
- [ ] Выбрано 0 кандидатов - кнопка неактивна
- [ ] Выбран 1 кандидат - корректный текст
- [ ] Выбрано 100 кандидатов - корректный текст
- [ ] Вакансия закрыта - не показывается
- [ ] Длинное название вакансии - обрезается
- [ ] Длинное название компании - обрезается

## Заключение

Функция добавления кандидатов к вакансиям является ключевой для CRM рекрутера. Она обеспечивает:

✅ **Быстроту** - один клик для отправки
✅ **Масштабируемость** - массовые операции
✅ **Прозрачность** - история всех действий
✅ **Удобство** - интуитивный интерфейс
✅ **Гибкость** - работает для всех сценариев

Это значительно ускоряет работу рекрутера и делает процесс подбора кандидатов более эффективным.
